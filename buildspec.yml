version: 0.2

phases:
    install:
        runtime-versions:
            python: 3.8
            dotnet: latest
        commands:
            - echo "Installing prerequistes..."
            - pip install ansible
            - pip install pywinrm
            - curl -fsSL https://apt.corretto.aws/corretto.key > /etc/apt/trusted.gpg.d/corretto.asc
            - apt-key del A122542AB04F24E3 && sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys A122542AB04F24E3
            - wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo tee /etc/apt/trusted.gpg.d/google.asc >/dev/null
            - wget -q https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
            - sudo dpkg -i packages-microsoft-prod.deb
            - rm packages-microsoft-prod.deb
            - apt-get update
            - apt-get install -y powershell
            - pwsh -Command "$PSVersionTable.PSVersion"
    pre_build:
        commands:
            - echo "Installing dependencies..."
            - ansible --version
    build:
        commands:
            - echo "Building project..."
            - pwsh -Command "/AnsibleWinRMconfig.ps1"
            - ansible-playbook -i inventory dcpromo.yml
    post_build:
        commands:
            - echo "Build completed..."